<template>
  <div class="flex items-center justify-center">
    <div class="flex flex-col rounded-lg w-3/4 max-h-fit border border-gray-300 p-10">
      <h1>Visual Acuity</h1>
      <br />
      <div class="flex flex-col">
        <!-- Row 1 -->
        <div class="flex flex-row mb-2">
          <!-- L eye vision -->
          <div class="w-1/2">
            <label for="" class="mb-1 block text-sm font-medium text-dark">
              L eye vision (6/)
            </label>
            <input v-model="lEyeVision" type="number" step="1" placeholder=""
              class="w-full bg-transparent rounded-md border border-stroke py-1.5 px-3 text-sm text-dark-6 outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-gray-2 disabled:border-gray-2"
              :disabled="!isEditing && !isAdd" />
          </div>

          <!-- R eye vision -->
          <div class="ml-3 w-1/2">
            <label for="" class="mb-1 block text-sm font-medium text-dark">
              R eye vision (6/)
            </label>
            <input v-model="rEyeVision" type="number" step="1" placeholder=""
              class="w-full bg-transparent rounded-md border border-stroke py-1.5 px-3 text-sm text-dark-6 outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-gray-2 disabled:border-gray-2"
              :disabled="!isEditing && !isAdd" />
          </div>
        </div>

        <!-- Additional Intervention -->
        <div class="mt-4">
          <label for="" class="mb-2 block text-sm font-medium text-dark">Additional Intervention:
          </label>
          <textarea v-model="additionalIntervention" rows="3" placeholder="Remarks"
            class="w-full bg-transparent rounded-md border border-stroke p-3 font-normal text-sm text-dark-4 outline-none transition focus:border-primary active:border-primary disabled:cursor-default disabled:bg-gray-2"
            :disabled="!isEditing && !isAdd"></textarea>
        </div>

        <!-- Save Button -->
        <div class="flex flex-row-reverse w-full mt-5">
          <button v-if="isAdd" @click="submitData"
            class="px-5 py-2 transition ease-in duration-200 rounded-lg text-sm text-[#3f51b5] hover:bg-[#3f51b5] hover:text-white border-2 border-[#3f51b5] focus:outline-none">
            Save
          </button>
        </div>

        <!-- Edit Button -->
        <div class="flex flex-row-reverse w-full mt-5">
          <button v-if="!isEditing && !isAdd" @click="toggleEdit"
            class="px-5 py-2 transition ease-in duration-200 rounded-lg text-sm text-[#3f51b5] hover:bg-[#3f51b5] hover:text-white border-2 border-[#3f51b5] focus:outline-none">
            Edit
          </button>
        </div>

        <!-- Save Edits Button -->
        <div class="flex flex-row-reverse w-full mt-5">
          <button v-if="isEditing && !isAdd" @click="submitData"
            class="px-5 py-2 transition ease-in duration-200 rounded-lg text-sm text-[#3f51b5] hover:bg-[#3f51b5] hover:text-white border-2 border-[#3f51b5] focus:outline-none">
            Save Edits
          </button>
        </div>

      </div>
    </div>
  </div>
</template>

<script>
import axios from 'axios'
import { useToast } from 'vue-toast-notification'
import 'vue-toast-notification/dist/theme-sugar.css'

export default {
  props: {
    patientId: {
      type: Number,
      required: true
    },
    patientData: {
      type: Object,
      default: null
    },
    isAdd: {
      type: Boolean,
      default: true
    }
  },
  data() {
    return {
      lEyeVision: null,
      rEyeVision: null,
      additionalIntervention: '',
      isEditing: false,
    }
  },
  created() {
    if (!this.isAdd) {
      const visualAcuity = this.patientData.visualacuity;
      if (!visualAcuity) return;
      this.lEyeVision = visualAcuity.lEyeVision;
      this.rEyeVision = visualAcuity.rEyeVision;
      this.additionalIntervention = visualAcuity.additionalIntervention || "";
    }
  },
  methods: {
    async submitData() {
      const toast = useToast()
      try {
        if (this.lEyeVision === null) {
          toast.error('Please fill in L eye vision')
          return
        }
        if (this.rEyeVision === null) {
          toast.error('Please fill in R eye vision')
          return
        }
        const response = await axios.patch(`/patient/${this.patientId}`, {
          visualAcuity: {
            lEyeVision: this.lEyeVision,
            rEyeVision: this.rEyeVision,
            additionalIntervention: this.additionalIntervention
          }
        })
        console.log(response.data)
        console.log('Visual Acuity posted successfully!')
        if (!this.isAdd) {
          this.toggleEdit(); // to switch back to read-only mode
          this.$emit('reload')
        }
        toast.success('Visual Acuity posted successfully!')
      } catch (error) {
        console.error('Error posting data:', error)
        toast.error('Error saving Visual Acuity ')
        if (error.response) {
            toast.error(error.response.data.error)
        } else { // No response received at all
          toast.error("An internal server error occurred.")
        }
      }
    },

    toggleEdit() {
      console.log('toggleEdit')
      this.isEditing = !this.isEditing
      console.log(this.isEditing)
    },

  }
}
</script>

<style scoped>
h1 {
  font-size: 1.25rem;
  font-weight:500;
}
</style>
